# 핵심 개념 간략 정리: 23장 실행 컨텍스트

## 23.1 소스코드의 타입

1. 전역 코드
   - 전역 변수, 함수 선언문으로 정의된 전역 함수 관리
   - 코드 평가 후 전역 실행 컨텍스트 생성
   - ⚠️ `var` 키워드로 선언된 전역 변수만 전역 객체의 프로퍼티로 바인딩 되고, `let`, `const` 키워드로 선언된 전역 변수는 전역 환경 레코드의 선언적 환경 레코드에 존재
2. 함수 코드
   - 지역 스코프 생성, 지역 변수, 매개변수, `arguments` 객체 관리
   - 코드 평가 후 함수 실행 컨텍스트 생성
3. `eval` 코드
   - strict mode에서 독자적 스코프를 생성
   - 코드 평가 후 `eval` 실행 컨텍스트 생성
4. 모듈 코드
   - 모듈별로 독립적인 모듈 스코프 생성
   - 코드 평가 후 모듈 실행 컨텍스트 생성

## 23.2 소스코드의 평가와 실행

- 자바스크립트 엔진은 소스코드를 “평가”와 “실행”의 2가지 과정으로 나눠 처리한다.
- **소스코드 평가 과정에서 수행하는 일**
  - 모든 소스코드는 실행에 앞서 평가 과정을 거쳐 코드 실행을 위한 준비를 한다.
  - 실행 컨텍스트 생성
  - 변수 / 함수 등 선언문 먼저 실행 → 변수 / 함수 식별자를 key로 렉시컬 환경의 환경 레코드에 등록
- **소스코드 실행 과정에서 수행하는 일**
  - 런타임 시 소스코드 실행에 필요한 정보를 실행 컨텍스트가 관리하는 스코프에서 검색해 취득한다.
  - 변수나 함수의 참조를 실행 컨텍스트가 관리하는 스코프에서 검색 → 취득
  - 변수 값 변경 등 소스코드의 실행 결과를 다시 실행 컨텍스트가 관리하는 스코프에 등록

## 23.3 실행 컨텍스트의 역할

- [23.3 본문 예제](https://github.com/FE-FOREVER/JS-STUDY/blob/main/23.%20%EC%8B%A4%ED%96%89%20%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8/%EC%A1%B0%EB%AF%BC%EC%A7%80.md#233-%EC%8B%A4%ED%96%89-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8%EC%9D%98-%EC%97%AD%ED%95%A0)를 통해 알 수 있는 점
  - 코드 실행을 위해선 스코프를 구분해 식별자와 바인딩된 값 지속적 관리 필요
  - 중첩 관계에 의해 스코프 체인을 형성해 식별자 검색 가능 필요
  - 전역 객체의 프로퍼티도 전역 변수처럼 검색 가능 필요
  - 함수 호출 종료 시 함수 호출 이전으로 되돌아가기 위해 현재 실행 중인 코드와 이전에 실행하던 코드 구분해 관리 필요
- 실행 컨텍스트
  - 코드 실행을 위해 필요한 스코프, 식별자, 코드 실행 순서 등의 관리를 하는 것
  - 소스코드 실행에 필요한 환경 제공 & 코드 실행 결과 실제 관리
  - 식별자 등록&관리 스코프 + 코드 실행 순서 관리
  - 모든 코드는 실행 컨텍스트를 통해 실행되고 관리된다.
  - **식별자와 스코프** → **실행 컨텍스트의 렉시컬 환경**으로 관리
  - **코드 실행 순서** → **실행 컨텍스트 스택**으로 관리

## 23.4 실행 컨텍스트 스택

- 코드 실행 시 생성되는 실행 컨텍스트를 stack 자료구조 형태로 관리하는 것
- 코드 실행 흐름에 따라 스택에 실행 컨텍스트가 push, pop된다.
- **코드 실행 순서 관리**
- 소스코드 평가 시 실행 컨텍스트 생성 → 실행 컨텍스트 스택 최상위에 push
- 실행 컨텍스트 스택의 **최상위**에 존재하는 실행 컨텍스트는 **언제나 현재 실행 중**인 코드의 실행 컨텍스트
- [예제로 살펴보기](https://github.com/FE-FOREVER/JS-STUDY/blob/main/23.%20%EC%8B%A4%ED%96%89%20%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8/%EC%A1%B0%EB%AF%BC%EC%A7%80.md#234-%EC%8B%A4%ED%96%89-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8-%EC%8A%A4%ED%83%9D)

## 23.5 렉시컬 환경

- 식별자와 식별자에 바인딩된 값, 상위 스코프에 대한 참조를 기록하는 자료구조
- **스코프를 구분**해 **식별자를 등록하고 관리**하는 저장소
- **실행 컨텍스트**의 구성: **LexicalEnvironment** 컴포넌트와 **VariableEnvironment** 컴포넌트로 구성
  - 생성 초기에 두 컴포넌트는 하나의 동일한 렉시컬 환경을 참조
- **렉시컬 환경**의 구성: **EnvironmentRecord** 컴포넌트와 **OuterLexicalEnvironmentReference** 컴포넌트로 구성
  - **EnvironmentRecord** 컴포넌트(환경 레코드)
    - 스코프에 포함된 식별자를 등록, 등록된 식별자에 바인딩된 값을 관리하는 저장소
  - **OuterLexicalEnvironmentReference** 컴포넌트(외부 렉시컬 환경에 대한 참조)
    - 상위 스코프(외부 렉시컬 환경)를 가리킨다.
    - 이 컴포넌트를 통해 단방향 링크드 리스트인 스코프 체인을 구현한다.

## 23.6 실행 컨텍스트의 생성과 식별자 검색 과정

```jsx
var x = 1;
const y = 2;

function foo(a) {
  var x = 3;
  const y = 4;

  function bar(b) {
    const z = 5;
    console.log(a + b + x + y + z);
  }
  bar(10);
}

foo(20); // 42
```

### **1. 전역 객체 생성**

- 이때 전역 객체에는 빌트인 전역 프로퍼티와 빌트인 전역 함수, 그리고 표준 빌트인 객체가 추가되며
- **동작 환경**(클라이언트 사이드 또는 서버 사이드)**에 따라**
  **클라이언트 사이드 Web API\***(DOM, BOM, Canvas, XMLHttpRequest, fetch, requestAnimationFrame, SVG, Web Storage, Web Component, Web Worker 등)\* **또는 특정 환경**을 위한 **호스트 객체**를 포함한다 .

### **2. 전역 코드 평가**

> **전역 코드 평가 진행 순서**
>
> 1. 전역 실행 컨텍스트 생성
> 2. 전역 렉시컬 환경 생성
>
>    2.1 전역 환경 레코드 생성
>
>    2.1.1 객체 환경 레코드 생성
>
>    2.1.2 선언적 환경 레코드 생성
>
> 2.2 this 바인딩
>
> 2.3 외부 렉시컬 환경에 대한 참조 결정

### **3. 전역 코드 실행**

1. 변수 할당문이 실행되어 전역 변수 x, y에 값이 할당된다.
2. foo 함수가 호출된다.

### **4. foo 함수 코드 평가**

> **함수 코드 평가 순서**
>
> 1. 함수 실행 컨텍스트 생성
> 2. 함수 렉시컬 환경 생성
>
>    2.1. 함수 환경 레코드 생성
>
>    2.2 this 바인딩
>
>    2.3. 외부 렉시컬 환경에 대한 참조 결정

### **5. foo 함수 코드 실행**

1. **매개변수에 인수가 할당**되고, **변수 할당문이 실행**되어 지역 변수 x, y에 값이 할당된다.
2. bar 함수가 호출된다.
3. 이때 **식별자 결정**을 위해 **실행 중인 실행 컨텍스트의 렉시컬 환경**에서 식별자를 검색하기 시작한다.
4. **현재 실행 중인 실행 컨텍스트**는 foo 함수 실행 컨텍스트이므로 **foo 함수 렉시컬 환경**에서 식별자 x, y를 검색하기 시작한다.
5. 만약 실행 중인 실행 컨텍스트의 렉시컬 환경에서 **식별자를 검색할 수 없으면** 외부 렉시컬 환경에 대한 참조가 가리키는 렉시컬 환경으로 이동하여 식별자를 검색한다.
6. 다행히 모든 식별자는 **현재 실행 중인 실행 컨텍스트의 렉시컬 환경에서 모두 검색할 수 있다**.
7. **검색된 식별자에 값을 바인딩**한다.

### **6. bar 함수 코드 평가**

1. bar 함수가 호출되면 bar 함수 내부로 코드의 제어권이 이동한다.
2. 그리고 bar 함수 코드를 평가하기 시작한다.
3. 실행 컨텍스트와 렉시컬 환경의 생성 과정은 foo 함수 코드 평가와 동일하다.

### **7. bar 함수 코드 실행**

- 매개변수에 인수가 할당되고, 변수 할당문이 실행되어 지역 변수 z에 값이 할당된다.

### **8. bar 함수 코드 실행 종료**

1. `console.log` 메서드가 호출되고 종료하면 더는 실행할 코드가 없으므로 bar 함수 코드의 실행이 종료된다.
2. 이때 **실행 컨텍스트 스택**에서 **bar 함수 실행 컨텍스트가 팝되어 제거**되고 foo 실행 컨텍스트가 실행 중인 실행 컨텍스트가 된다.
3. 실행 컨텍스트 스택에서 bar 함수 실행 컨텍스트가 제거되었다고 해서 bar 함수 렉시컬 환경까지 즉시 소멸하는 것은 아니다.
4. **렉시컬 환경**은 실행 컨텍스트에 의해 참조되기는 하지만 독립적인 객체다.
5. 객체를 포함한 모든 값은 누군가에 의해 참조되지 않을 때 비로소 가비지 컬렉터에 의해 메모리 공간의 확보가 해제되어 소멸한다.
6. bar 함수 실행 컨텍스트가 소멸되었다 하더라도 만약 bar 함수 렉시컬 환경을 누군가 참조하고 있다면 bar 함수 렉시컬 환경은 소멸하지 않는다.

### **9. foo 함수 코드 실행 종료**

1. bar 함수가 종료하면 더 이상 실행할 코드가 없으므로 foo 함수 코드의 실행이 종료된다.
2. 이때 **실행 컨텍스트 스택**에서 **foo 함수 실행 컨텍스트가 팝되어 제거**되고 전역 실행 컨텍스트가 실행 중인 실행 컨텍스트가 된다.

### **10. 전역 코드 실행 종료**

foo 함수가 종료되면 **더는 실행할 전역 코드가 없으므로** 전역 코드의 실행이 종료되고 **전역 실행 컨텍스트도 실행 컨텍스트 스택에서 팝**되어 실행 컨텍스트 스택에는 아무것도 남아있지 않게 된다.

## 23.7 실행 컨텍스트와 블록 레벨 스코프

```jsx
let x = 1;

if (true) {
  let x = 10;
  console.log(x); // 10
}
console.log(x); // 1
```

- if 문의 코드 블록 내에서 `let 키워드`로 변수가 선언되었다.
- 따라서 if 문의 코드 블록이 실행되면 if 문의 코드 블록을 위한 `블록 레벨 스코프를 생성`해야 한다.
- 이를 위해 선언적 환경 레코드를 갖는 **렉시컬 환경을 새롭게 생성**하여 기존의 전역 렉시컬 환경을 교체한다.
- 이때 새롭게 생성된 if 문의 코드 블록을 위한 **렉시컬 환경의 외부 렉시컬 환경에 대한 참조**는 if 문이 실행되기 이전의 전역 렉시컬 환경을 가리킨다.
